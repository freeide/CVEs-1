# CVE-2020-0674

## Background

Learn a lot from maxpl0it's writeup and try to write a x86 version exploit on windows 7 x86 with IE11. Analyze and record why GC crashes.
## Detail

Why GC crash in function ```rewrite()```?

### Summary about GC

+ GC use mark-sweep algorithm. maxpl0it's [writeup](https://labs.f-secure.com/blog/internet-exploiter-understanding-vulnerabilities-in-internet-explorer/) shows more details about GC.
    - Mark
    - Scavenge
    - Reclaim
+ Regard scavenge as unmark.

### Crash

Function ```CIndexedNameList::ScavengeRoots``` is different in jscript.dll x86 vserion.

```CIndexedNameList``` is ```Array```. So when handles ```total``` which has 0x132 VAR(0x80), the function unmarks all VARs in the GcBlock(be freed and reallocated). This process changes the second Vval's next filed.
```
0:012> dd 087248a0
087248a0  69cb1924 00000004 00000004 08893788    --------<NameList>
087248b0  000003d4 00000644 00000100 00004000
087248c0  0889378c 08893b4c 086888d8 0000000f
087248d0  00000040 00000004 0000000a 087248e0
087248e0  0889378c 08893ab0 08893af8 08893b2c
087248f0  00000000 00000000 00000000 00000000
08724900  00000000 00000000 6332436f 88000000
08724910  69cb1924 00000004 00000004 08893e10
0:012> dd 0889378c
0889378c  02810003 0541b5a4 00000001 00000000    --------<First Vval>
0889379c  00000000 00000000 dfd98ab6 000002f0
088937ac  08893ab0 00000000 00000001 089a7698
088937bc  00410041 00000080 00000000 06358bec
088937cc  00000000 00000080 00000000 06358bec
088937dc  00000000 00000080 00000000 06358bec
088937ec  00000000 00000080 00000000 06358bec
088937fc  00000000 00000080 00000000 06358bec
0:012> dd 08893ab0
08893ab0  02810003 0541bda4 00000001 00000000    --------<Second Vval>
08893ac0  00000000 00000000 01fe769b 00000016
08893ad0  088932f8 00000000 00000002 08893ae0
08893ae0  00410041 00410041 00410041 00410041
08893af0  00410041 00000041 02810003 0541bda4
08893b00  00000001 00000000 00000000 08893b10
08893b10  00000005 00000002 08893b2c 00000000
08893b20  00000003 00000000 00000005 02810003
0:012> dd 08893af8
08893af8  02810003 0541bda4 00000001 00000000    --------<Third Vval>
08893b08  00000000 08893b10 00000005 00000002
08893b18  08893b2c 00000000 00000003 00000000
08893b28  00000005 02810003 0541b5a4 00000001
08893b38  00000000 00000000 00000000 00000061
08893b48  00000002 00000000 00000000 00000004
08893b58  089a6818 00000041 00000000 00000000
08893b68  089a67d8 08893b70 00000000 00000000
```

```0x3af8 & 0xf7ff = 0x32f8```

The second Vval's next filed is wrong. 

Gc will crash when traverse all elements in function ```NameList::ScavengeRoots```
```
eax=05ac8bec ebx=0000f7ff ecx=05ac8bec edx=00000081 esi=00000080 edi=01f083b8
eip=67a06a6a esp=049ba6cc ebp=049ba6d8 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010202
jscript!NameList::ScavengeRoots+0x20:
67a06a6a 0fb706          movzx   eax,word ptr [esi]       ds:0023:00000080=????
0:012> k
 # ChildEBP RetAddr  
00 049ba6d8 67a06941 jscript!NameList::ScavengeRoots+0x20
01 049ba6ec 67a06dd0 jscript!NameTbl::ScavengeCore+0x42
02 049ba700 67a06cef jscript!GcContext::CollectCore+0xc6
03 049ba718 67a5a465 jscript!GcContext::Collect+0x26
04 049ba71c 67a05950 jscript!JsCollectGarbage+0x1c
05 049ba784 67a02fe9 jscript!NatFncObj::Call+0xce
06 049ba80c 67a02c68 jscript!NameTbl::InvokeInternal+0x108
07 049ba8f4 67a02bbb jscript!VAR::InvokeByDispID+0x70
```
### How to fix it?

we need ```total = new Array();```

